<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operacional - Batalh√£o Leste</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* CSS COMPLETO DO C√ìDIGO ATUAL.TXT */
        :root {
            --primary-dark: #1a237e;
            --primary-blue: #1976d2;
            --accent-cyan: #00bcd4;
            --success-green: #4caf50;
            --warning-orange: #ff9800;
            --danger-red: #f44336;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); min-height: 100vh; color: var(--text-primary); }

        /* Header com gradiente moderno */
        .header { background: var(--bg-gradient); color: white; padding: 24px 40px; box-shadow: var(--shadow-lg); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-content { max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .logo-section { display: flex; align-items: center; gap: 16px; }
        .logo-icon { width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(10px); }
        .header h1 { font-size: 1.8rem; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header-subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; }
        .header-actions { display: flex; gap: 12px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
        .btn-primary { background: white; color: var(--primary-dark); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }

        /* Container principal */
        .container { max-width: 1800px; margin: 0 auto; padding: 24px; }

        /* Grid de m√©tricas principais */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .metric-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-md); position: relative; overflow: hidden; transition: all 0.3s ease; border-left: 4px solid; }
        .metric-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .metric-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: currentColor; opacity: 0.05; border-radius: 50%; transform: translate(30%, -30%); }
        .metric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .metric-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: currentColor; color: white; opacity: 0.9; }
        .metric-label { font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); line-height: 1; margin: 8px 0; }
        .metric-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
        .metric-trend { display: inline-flex; align-items: center; gap: 4px; font-size: 0.8rem; font-weight: 600; margin-top: 8px; padding: 4px 8px; border-radius: 4px; }
        .trend-positive { background: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .trend-negative { background: rgba(244, 67, 54, 0.1); color: var(--danger-red); }

        /* Cores das m√©tricas */
        .metric-efetivo { border-color: var(--primary-blue); color: var(--primary-blue); }
        .metric-presente { border-color: var(--success-green); color: var(--success-green); }
        .metric-ausente { border-color: var(--danger-red); color: var(--danger-red); }
        .metric-vtr { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .metric-pog { border-color: var(--warning-orange); color: var(--warning-orange); }

        /* Layout principal com sidebar */
        .main-layout { display: grid; grid-template-columns: 280px 1fr; gap: 24px; margin-bottom: 24px; }

        /* Sidebar de filtros */
        .sidebar { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-md); height: fit-content; position: sticky; top: 120px; }
        .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0; }
        .sidebar-header i { font-size: 20px; color: var(--primary-blue); }
        .sidebar-header h3 { font-size: 1.1rem; color: var(--text-primary); }
        .filter-group { margin-bottom: 20px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
        .filter-group select, .filter-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; background: #fafafa; transition: all 0.3s ease; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--primary-blue); background: white; }
        .btn-reset { width: 100%; margin-top: 16px; background: #f5f5f5; color: var(--text-primary); }
        .btn-reset:hover { background: #e0e0e0; }

        /* Grid de gr√°ficos */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-md); transition: all 0.3s ease; }
        .chart-card:hover { box-shadow: var(--shadow-lg); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0; }
        .chart-title { display: flex; align-items: center; gap: 12px; font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .chart-title i { color: var(--primary-blue); }
        .chart-wrapper { position: relative; height: 300px; }

        /* Tabela detalhada */
        .table-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-md); margin-bottom: 24px; }
        .table-wrapper { max-height: 600px; overflow-y: auto; border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table thead { position: sticky; top: 0; background: var(--primary-dark); color: white; z-index: 10; }
        .data-table th { padding: 16px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; }
        .data-table tbody tr { transition: background 0.2s ease; }
        .data-table tbody tr:hover { background: #f8f9fa; }
        
        .status-badge { padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .status-presente { background: rgba(76, 175, 80, 0.15); color: var(--success-green); }
        .status-ferias { background: rgba(255, 152, 0, 0.15); color: var(--warning-orange); }
        .status-afastado { background: rgba(244, 67, 54, 0.15); color: var(--danger-red); }
        .status-licenca { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }
        .status-dispensado { background: rgba(158, 158, 158, 0.15); color: #666; }

        /* Loading spinner */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Alert messages */
        .alert-container { position: fixed; top: 100px; right: 24px; max-width: 400px; z-index: 1000; }
        .alert { padding: 16px 24px; border-radius: 8px; color: white; font-weight: 600; box-shadow: var(--shadow-lg); margin-bottom: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .alert-success { background: var(--success-green); }
        .alert-error { background: var(--danger-red); }

        /* Media Queries - Responsividade */
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { position: static; top: auto; }
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    <div class="alert-container" id="alertContainer"></div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon"><i class="fas fa-chart-bar"></i></div>
                <div>
                    <h1>Dashboard Operacional - Batalh√£o Leste</h1>
                    <div class="header-subtitle" id="updateTime"></div>
                </div>
            </div>
            <div class="header-actions">
                <input type="file" id="fileInput" style="display: none;" accept=".xlsx, .xls, .csv">
                <label for="fileInput" class="btn btn-secondary">
                    <i class="fas fa-file-upload"></i> Carregar Planilha
                </label>
                <button class="btn btn-primary" onclick="clearData()">
                    <i class="fas fa-trash-alt"></i> Limpar Dados
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="metrics-grid">
            <div class="metric-card metric-efetivo">
                <div class="metric-header">
                    <div class="metric-label">Efetivo Total</div>
                    <i class="fas fa-users metric-icon"></i>
                </div>
                <div class="metric-value" id="efetivoTotal">0</div>
                <div class="metric-subtitle">Total de Policiais no Batalh√£o</div>
            </div>

            <div class="metric-card metric-presente">
                <div class="metric-header">
                    <div class="metric-label">Efetivo Presente</div>
                    <i class="fas fa-check-circle metric-icon"></i>
                </div>
                <div class="metric-value" id="efetivoPresente">0</div>
                <div class="metric-subtitle">Policiais em Servi√ßo/Guarni√ß√£o</div>
            </div>

            <div class="metric-card metric-ausente">
                <div class="metric-header">
                    <div class="metric-label">Efetivo Ausente</div>
                    <i class="fas fa-times-circle metric-icon"></i>
                </div>
                <div class="metric-value" id="efetivoAusente">0</div>
                <div class="metric-subtitle">F√©rias/Dispensa/Afastamento</div>
            </div>

            <div class="metric-card metric-vtr">
                <div class="metric-header">
                    <div class="metric-label">Viaturas (VTR)</div>
                    <i class="fas fa-car-side metric-icon"></i>
                </div>
                <div class="metric-value" id="totalVTR">0</div>
                <div class="metric-subtitle">Total de Viaturas em Servi√ßo</div>
            </div>
            
            <div class="metric-card metric-pog">
                <div class="metric-header">
                    <div class="metric-label">Policiamento (POG)</div>
                    <i class="fas fa-motorcycle metric-icon"></i>
                </div>
                <div class="metric-value" id="totalPOG">0</div>
                <div class="metric-subtitle">Total de Policiamento a P√©/Moto</div>
            </div>
        </div>

        <div class="main-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <i class="fas fa-filter"></i>
                    <h3>Filtros de An√°lise</h3>
                </div>

                <div class="filter-group">
                    <label for="unidadeFilter">Filtrar por OPM:</label>
                    <select id="unidadeFilter" onchange="filterDashboard()">
                        <option value="">Todas as OPMs</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="graduacaoFilter">Filtrar por Gradua√ß√£o:</label>
                    <select id="graduacaoFilter" onchange="filterDashboard()">
                        <option value="">Todas as Gradua√ß√µes</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="localFilter">Filtrar por Local:</label>
                    <select id="localFilter" onchange="filterDashboard()">
                        <option value="">Todos os Locais</option>
                    </select>
                </div>

                <button class="btn btn-secondary btn-reset" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> Limpar Filtros
                </button>
            </aside>

            <main>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title"><i class="fas fa-shield-alt"></i> Efetivo por OPM</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="unidadeChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title"><i class="fas fa-user-tag"></i> Status do Efetivo</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title"><i class="fas fa-star"></i> Distribui√ß√£o por Gradua√ß√£o</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="graduacaoChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title"><i class="fas fa-map-marked-alt"></i> Efetivo por Local de Atua√ß√£o</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="localChart"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div class="table-card">
            <div class="chart-header">
                <div class="chart-title"><i class="fas fa-table"></i> Detalhamento do Efetivo</div>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="detalhesTable">
                    <thead>
                        <tr>
                            <th>OPM</th>
                            <th>Posto/Grad</th>
                            <th>Nome de Guerra</th>
                            <th>Local de Atua√ß√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="detalhesTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                Carregue uma planilha para visualizar os dados.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
### 2. Fun√ß√µes JavaScript (Unifica√ß√£o dos C√≥digos)

Este bloco de script cont√©m as fun√ß√µes essenciais para o controle operacional, utilizando a l√≥gica de leitura do Excel (CSV/XLSX) do c√≥digo da Opera√ß√£o Natal.

```javascript
    <script>
        // Vari√°veis globais
        let fullData = []; // Armazena os dados brutos carregados
        let unitResourcesData = {}; // Armazena VTR e POG por Unidade
        let charts = { unidade: null, status: null, graduacao: null, local: null }; // Gerenciamento dos objetos Chart.js
        let validUnits = new Set();
        let validGraduacoes = new Set();
        let validLocais = new Set();
        
        // Mapeamento das colunas (Baseado no snippet do C√≥digo atual.txt)
        const COLUMN_MAP = {
            unidade: 'UNIDADE',
            graduacao: 'POSTO/GRAD',
            nome: 'NOME DE GUERRA',
            local: 'LOCAL DE ATUA√á√ÉO',
            status: 'STATUS DO EFETIVO',
            vtr: 'VTR (Total)',
            pog: 'POG (Total)'
        };

        // --- FUN√á√ïES DE UTILIDADE (ADAPTADAS DO C√ìDIGO OP NATAL.TXT) ---

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(400px)';
                alert.addEventListener('transitionend', () => alert.remove());
            }, 5000);
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('updateTime').textContent = `Atualizado em: ${dateStr} √†s ${timeStr}`;
        }
        
        function findColumn(row, key) {
            const normalizedKey = key.toLowerCase().trim();
            for (const col in row) {
                if (col.toLowerCase().trim() === normalizedKey) {
                    return row[col];
                }
            }
            return ''; // Retorna string vazia se a coluna n√£o for encontrada
        }
        
        function parseNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleanValue = value.replace(',', '.'); // Permite v√≠rgula decimal
                const num = parseFloat(cleanValue);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        function normalizeStatus(status) {
            if (!status) return 'INDETERMINADO';
            const normalized = status.toUpperCase().trim();
            if (normalized.includes('PRESEN')) return 'PRESENTE';
            if (normalized.includes('F√âRIAS')) return 'DE F√âRIAS';
            if (normalized.includes('AFAST')) return 'AFASTADO';
            if (normalized.includes('LICEN√áA')) return 'LICEN√áA';
            if (normalized.includes('DISPENS')) return 'DISPENSADO';
            return 'OUTROS';
        }

        // --- FUN√á√ïES DE PROCESSAMENTO E ATUALIZA√á√ÉO DO DASHBOARD ---

        function processExcelData(jsonData) {
            showLoading(true);
            fullData = [];
            unitResourcesData = {};
            validUnits = new Set();
            validGraduacoes = new Set();
            validLocais = new Set();

            try {
                jsonData.forEach(row => {
                    const unidade = findColumn(row, COLUMN_MAP.unidade);
                    const graduacao = findColumn(row, COLUMN_MAP.graduacao);
                    const nome = findColumn(row, COLUMN_MAP.nome);
                    const local = findColumn(row, COLUMN_MAP.local);
                    const status = normalizeStatus(findColumn(row, COLUMN_MAP.status));
                    const vtr = parseNumber(findColumn(row, COLUMN_MAP.vtr));
                    const pog = parseNumber(findColumn(row, COLUMN_MAP.pog));

                    // Preenchimento dos dados de efetivo
                    if (unidade && nome) {
                        fullData.push({
                            unidade,
                            graduacao,
                            nome,
                            local,
                            status,
                            presente: status === 'PRESENTE' ? 1 : 0,
                            ausente: status !== 'PRESENTE' ? 1 : 0
                        });
                    }

                    // Preenchimento dos dados de VTR/POG (Recursos)
                    if (unidade) {
                         validUnits.add(unidade);
                        if (!unitResourcesData[unidade]) {
                            unitResourcesData[unidade] = { VTR: 0, POG: 0 };
                        }
                        // Assume que o valor mais alto de VTR/POG para uma unidade √© o total
                        if (vtr > unitResourcesData[unidade].VTR) unitResourcesData[unidade].VTR = vtr;
                        if (pog > unitResourcesData[unidade].POG) unitResourcesData[unidade].POG = pog;
                    }

                    if (graduacao) validGraduacoes.add(graduacao);
                    if (local) validLocais.add(local);
                });

                if (fullData.length === 0) {
                    throw new Error('Nenhum dado de efetivo v√°lido encontrado na planilha.');
                }

                // Atualiza os filtros e o dashboard completo
                updateFilters();
                filterDashboard(); 
                showAlert(`‚úÖ Sucesso! ${fullData.length} registros de efetivo processados.`, 'success');

            } catch (error) {
                console.error('‚ùå Erro no processamento:', error);
                showAlert('‚ùå Erro ao processar dados: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function clearData() {
            fullData = [];
            unitResourcesData = {};
            validUnits = new Set();
            validGraduacoes = new Set();
            validLocais = new Set();
            updateFilters(); // Limpa os dropdowns
            filterDashboard(); // Limpa o dashboard
            showAlert('üóëÔ∏è Dados limpos com sucesso.', 'success');
        }

        function updateFilters() {
            const filters = [
                { id: 'unidadeFilter', data: Array.from(validUnits).sort() },
                { id: 'graduacaoFilter', data: Array.from(validGraduacoes).sort() },
                { id: 'localFilter', data: Array.from(validLocais).sort() }
            ];

            filters.forEach(filter => {
                const select = document.getElementById(filter.id);
                const selectedValue = select.value; // Mant√©m o valor selecionado
                select.innerHTML = `<option value="">Todas as ${filter.id.includes('unidade') ? 'OPMs' : (filter.id.includes('graduacao') ? 'Gradua√ß√µes' : 'Locais')}</option>`;
                
                filter.data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                });

                // Restaura o valor selecionado se ainda existir
                if (filter.data.includes(selectedValue)) {
                    select.value = selectedValue;
                }
            });
        }
        
        function resetFilters() {
            document.getElementById('unidadeFilter').value = '';
            document.getElementById('graduacaoFilter').value = '';
            document.getElementById('localFilter').value = '';
            filterDashboard();
        }

        function filterDashboard() {
            // Coleta os valores dos filtros
            const unidade = document.getElementById('unidadeFilter').value;
            const graduacao = document.getElementById('graduacaoFilter').value;
            const local = document.getElementById('localFilter').value;

            // Filtra os dados de efetivo
            const filteredEfetivo = fullData.filter(item => {
                const matchUnidade = unidade ? item.unidade === unidade : true;
                const matchGraduacao = graduacao ? item.graduacao === graduacao : true;
                const matchLocal = local ? item.local === local : true;
                return matchUnidade && matchGraduacao && matchLocal;
            });
            
            // Filtra os dados de recursos (VTR/POG) - Aplica apenas o filtro de Unidade, se houver
            let filteredResources = unitResourcesData;
            if (unidade) {
                filteredResources = {};
                if (unitResourcesData[unidade]) {
                    filteredResources[unidade] = unitResourcesData[unidade];
                }
            }
            
            // Atualiza o Dashboard
            updateMetrics(filteredEfetivo, filteredResources);
            updateCharts(filteredEfetivo);
            updateTable(filteredEfetivo);
            updateDateTime();
        }

        function updateMetrics(data, resources) {
            const totalEfetivo = data.length;
            const presente = data.filter(p => p.presente === 1).length;
            const ausente = data.filter(a => a.ausente === 1).length;
            
            let totalVTR = 0;
            let totalPOG = 0;
            
            // Soma os recursos (VTR/POG) das unidades filtradas
            for (const unit in resources) {
                totalVTR += resources[unit].VTR;
                totalPOG += resources[unit].POG;
            }

            document.getElementById('efetivoTotal').textContent = totalEfetivo;
            document.getElementById('efetivoPresente').textContent = presente;
            document.getElementById('efetivoAusente').textContent = ausente;
            document.getElementById('totalVTR').textContent = totalVTR;
            document.getElementById('totalPOG').textContent = totalPOG;
        }

        function updateCharts(data) {
            // Agrega√ß√µes
            const statusCounts = data.reduce((acc, curr) => {
                acc[curr.status] = (acc[curr.status] || 0) + 1;
                return acc;
            }, {});

            const unidadeCounts = data.reduce((acc, curr) => {
                acc[curr.unidade] = (acc[curr.unidade] || 0) + 1;
                return acc;
            }, {});
            
            const graduacaoCounts = data.reduce((acc, curr) => {
                acc[curr.graduacao] = (acc[curr.graduacao] || 0) + 1;
                return acc;
            }, {});
            
            const localCounts = data.reduce((acc, curr) => {
                acc[curr.local] = (acc[curr.local] || 0) + 1;
                return acc;
            }, {});

            // Desenhar Gr√°ficos
            drawChart('statusChart', statusCounts, 'doughnut', 'Distribui√ß√£o por Status', [
                'rgb(76, 175, 80)', 'rgb(255, 152, 0)', 'rgb(244, 67, 54)', 'rgb(156, 39, 176)', 'rgb(158, 158, 158)'
            ]);
            drawChart('unidadeChart', unidadeCounts, 'bar', 'Efetivo por OPM', ['#1976d2']);
            drawChart('graduacaoChart', graduacaoCounts, 'pie', 'Efetivo por Gradua√ß√£o', ['#667eea', '#764ba2', '#00bcd4', '#4caf50', '#ff9800']);
            drawChart('localChart', localCounts, 'bar', 'Efetivo por Local', ['#00bcd4']);
        }

        function getStatusColor(status) {
            switch (status.toUpperCase()) {
                case 'PRESENTE': return 'var(--success-green)';
                case 'DE F√âRIAS': return 'var(--warning-orange)';
                case 'AFASTADO': return 'var(--danger-red)';
                case 'LICEN√áA': return '#9c27b0';
                case 'DISPENSADO': return '#666';
                default: return 'var(--text-secondary)';
            }
        }
        
        function drawChart(canvasId, counts, type, label, defaultColors) {
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(counts);
            const data = Object.values(counts);
            
            let backgroundColors = [];
            if (canvasId === 'statusChart') {
                backgroundColors = labels.map(getStatusColor);
            } else {
                backgroundColors = defaultColors.length > 1 ? defaultColors : Array(data.length).fill(defaultColors[0]);
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: (type === 'bar' || type === 'line') ? {
                        y: { beginAtZero: true }
                    } : {},
                    plugins: {
                        legend: { position: type === 'doughnut' || type === 'pie' ? 'right' : 'top' },
                        title: { display: false }
                    }
                }
            });
        }

        function updateTable(data) {
            const tableBody = document.getElementById('detalhesTableBody');
            tableBody.innerHTML = ''; 

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: #7f8c8d;">
                    Nenhum dado encontrado para os filtros selecionados.
                </td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.unidade || '-';
                row.insertCell().textContent = item.graduacao || '-';
                row.insertCell().textContent = item.nome || '-';
                row.insertCell().textContent = item.local || '-';
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                
                // Mapeamento dos status para as classes CSS
                const statusClass = item.status.toLowerCase().replace(/ /g, '-').replace('de-f√©rias', 'ferias');
                
                statusBadge.className = `status-badge status-${statusClass}`;
                statusBadge.textContent = item.status || '-';
                statusCell.appendChild(statusBadge);
            });
        }

        // --- MANIPULA√á√ÉO DO ARQUIVO (DO C√ìDIGO OP NATAL.TXT) ---

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Converte para JSON
                    // raw: true mant√©m os valores como est√£o (√∫til para datas, mas aqui n√£o √© estritamente necess√°rio)
                    // header: 1 usa a primeira linha como cabe√ßalho de coluna
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, header: 1 });
                    
                    if (jsonData.length < 2) {
                        throw new Error('A planilha est√° vazia ou n√£o cont√©m dados v√°lidos.');
                    }
                    
                    // A primeira linha √© o cabe√ßalho
                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);
                    
                    // Cria objetos com as chaves corretas do cabe√ßalho
                    const processedJson = dataRows.map(row => {
                        let obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] !== undefined ? row[index] : '';
                        });
                        return obj;
                    });
                    
                    processExcelData(processedJson);

                } catch (error) {
                    console.error('‚ùå Erro na leitura:', error);
                    showAlert('‚ùå Erro ao ler arquivo: ' + error.message, 'error');
                    showLoading(false);
                }
            };
            
            reader.onerror = function(error) {
                console.error('‚ùå Erro no FileReader:', error);
                showAlert('‚ùå Erro ao ler o arquivo selecionado', 'error');
                showLoading(false);
            };
            
            reader.readAsArrayBuffer(file);
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000); // Atualiza o tempo a cada 1 minuto
            
            // Tenta carregar dados de exemplo (opcional, remova se n√£o quiser)
            // loadSampleData(); 
            filterDashboard(); // Inicializa o dashboard vazio
        });
        
        // Exemplo de dados para a fun√ß√£o loadSampleData (Opcional: use os dados da sua planilha CSV para criar o exemplo)
        // Se voc√™ quiser que o dashboard carregue com dados automaticamente, insira a fun√ß√£o loadSampleData aqui
        /*
        function loadSampleData() {
            const sampleData = [
                { "UNIDADE": "Batalh√£o Leste", "POSTO/GRAD": "MAJOR", "NOME DE GUERRA": "OLAVO", "LOCAL DE ATUA√á√ÉO": "Comando", "STATUS DO EFETIVO": "PRESENTE", "VTR (Total)": 5, "POG (Total)": 5 },
                // ... adicione mais linhas da sua planilha CSV aqui
            ];
            processExcelData(sampleData);
        }
        */
    </script>
</body>
</html>
